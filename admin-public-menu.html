<!-- ===== HF 管理：UI（統合版・完全） ===== -->
<div id="hf-admin-root">
  <h2>ヘッダー & フッター 管理</h2>

  <!-- ヘッダー設定 -->
  <section class="panel">
    <div class="panel-head">
      <h3>ヘッダー プレビュー</h3>
      <div class="panel-actions">
        <button id="saveHeaderBtn" class="btn primary">保存</button>
      </div>
    </div>
    <div id="headerPreview" class="preview-surface"></div>

    <div class="edit-grid">
      <div class="field"><label>会社名</label><input id="h_company_name" /></div>
      <div class="field"><label>ロゴURL</label><input id="h_logo_url" /></div>
      <div class="field"><label>ロゴ高さ(px)</label><input type="number" id="h_logo_height" /></div>

      <div class="field"><label>ロゴ位置</label>
        <select id="h_logo_alignment">
          <option>left</option><option>center</option><option>right</option>
        </select>
      </div>
      <div class="field"><label>会社名位置</label>
        <select id="h_company_alignment">
          <option>left</option><option>center</option><option>right</option>
        </select>
      </div>
      <div class="field"><label>ナビ位置</label>
        <select id="h_nav_alignment">
          <option>left</option><option>center</option><option>right</option>
        </select>
      </div>

      <div class="field"><label>背景色</label><input type="color" id="h_bg_color" /></div>
      <div class="field"><label>背景グラデーション</label><input id="h_bg_gradient" placeholder="linear-gradient(...)" /></div>
      <div class="field"><label>文字色</label><input type="color" id="h_text_color" /></div>

      <div class="field"><label>フォント</label><input id="h_font_family" placeholder="Noto Sans JP" /></div>
      <div class="field"><label>文字サイズ(px)</label><input type="number" id="h_font_size" /></div>
      <div class="field"><label>文字太さ</label>
        <select id="h_font_weight"><option>normal</option><option>bold</option></select>
      </div>

      <div class="field"><label>リンク間隔(px)</label><input type="number" id="h_link_spacing" /></div>
      <div class="field"><label>パディング</label><input id="h_padding" placeholder="8px 16px" /></div>
    </div>
  </section>

  <!-- フッター設定 -->
  <section class="panel">
    <div class="panel-head">
      <h3>フッター プレビュー</h3>
      <div class="panel-actions">
        <button id="saveFooterBtn" class="btn primary">保存</button>
      </div>
    </div>
    <div id="footerPreview" class="preview-surface"></div>

    <div class="edit-grid">
      <div class="field"><label>コピーライト</label><input id="f_footer_text" /></div>
      <div class="field"><label>配置</label>
        <select id="f_footer_alignment"><option>left</option><option>center</option><option>right</option></select>
      </div>

      <div class="field"><label>背景色</label><input type="color" id="f_bg_color" /></div>
      <div class="field"><label>背景グラデーション</label><input id="f_bg_gradient" placeholder="linear-gradient(...)" /></div>
      <div class="field"><label>文字色</label><input type="color" id="f_text_color" /></div>

      <div class="field"><label>フォント</label><input id="f_font_family" /></div>
      <div class="field"><label>文字サイズ(px)</label><input type="number" id="f_font_size" /></div>
      <div class="field"><label>文字太さ</label>
        <select id="f_font_weight"><option>normal</option><option>bold</option></select>
      </div>

      <div class="field"><label>リンク間隔(px)</label><input type="number" id="f_link_spacing" /></div>
      <div class="field"><label>固定表示</label><input type="checkbox" id="f_footer_fixed" /></div>
      <div class="field"><label>パディング</label><input id="f_padding" placeholder="8px 16px" /></div>
    </div>
  </section>

  <!-- メニュー管理 -->
  <section class="panel">
    <div class="panel-head">
      <h3>ヘッダー／フッター メニュー管理</h3>
      <div class="panel-actions">
        <button id="addMenuBtn" class="btn">新規追加</button>
      </div>
    </div>
    <div class="table-wrap">
      <table id="menuTable">
        <thead>
          <tr>
            <th>ID</th><th>タイトル</th><th>URL</th><th>並び順</th>
            <th>Header</th><th>Footer</th><th>公開</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<!-- トースト -->
<div id="toast-container"></div>

<!-- ===== 付帯スタイル ===== -->
<style>
  .panel { background:#fff; margin:16px 0; padding:16px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,.06); }
  .panel-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .panel-actions { display:flex; gap:8px; }
  .edit-grid { display:grid; grid-template-columns:repeat(2, minmax(240px, 1fr)); gap:12px; }
  .field { display:flex; flex-direction:column; }
  .field label { font-size:12px; color:#334155; margin-bottom:4px; }
  .btn { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#e2e8f0; }
  .btn.primary { background:#2563eb; color:#fff; }
  .preview-surface { border:1px dashed #cbd5e1; padding:16px; min-height:56px; border-radius:8px; background:#f8fafc;}
  .hf-header,.hf-footer { border-radius:8px; }
  .table-wrap { overflow:auto; }
  table { width:100%; border-collapse:collapse; }
  th,td { border-bottom:1px solid #e5e7eb; padding:8px; font-size:14px; }
  th { background:#f8fafc; text-align:left; }
  td.right { text-align:right; }
  .row-actions { display:flex; gap:6px; }
  .pill { display:inline-flex; padding:2px 8px; border-radius:999px; font-size:12px; }
  .pill.ok { background:#dcfce7; color:#166534; }
  .pill.ng { background:#fee2e2; color:#991b1b; }

  /* Toast */
  #toast-container { position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:9999; }
  .toast { background:#111827; color:#fff; padding:10px 12px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,.18); opacity:.98; }
  .toast.ok { background:#065f46; }
  .toast.warn { background:#92400e; }
  .toast.err { background:#7f1d1d; }
</style>

<!-- ===== Supabase クライアント（存在しなければロード） ===== -->
<script>
(function(){
  const SUPABASE_URL = "https://htnmjsqgoapvuanrsuma.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0bm1qc3Fnb2FwdnVhbnJzdW1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzI3MDEsImV4cCI6MjA3MDkwODcwMX0.1AACTWZmChfmIIfBad0sf-hLV2bnaUt7bVURXnd0uKA";

  /** toast */
  function toast(msg, type="ok"){
    const wrap = document.getElementById("toast-container");
    const el = document.createElement("div");
    el.className = "toast " + (type||"");
    el.textContent = msg;
    wrap.appendChild(el);
    setTimeout(()=>{ el.style.transition="opacity .3s"; el.style.opacity="0"; setTimeout(()=>el.remove(), 320); }, 2200);
  }
  window.__toast = toast;

  /** load supabase if missing */
  function ensureSupabase(){
    return new Promise((resolve, reject)=>{
      if (window.supabase && window.supabase.createClient) return resolve();
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
      s.onload = ()=> resolve();
      s.onerror = (e)=> reject(e);
      document.head.appendChild(s);
    });
  }

  /** Main */
  (async function main(){
    try{
      await ensureSupabase();
      const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

      // ----- 状態
      let headerRow=null, footerRow=null;

      const DEFAULT_HEADER = {
        area:"header",
        company_name:"", logo_url:"", logo_height:48,
        logo_alignment:"left", company_alignment:"left", nav_alignment:"right",
        bg_color:"#111827", bg_gradient:"", text_color:"#ffffff",
        font_family:"Noto Sans JP", font_size:16, font_weight:"normal",
        link_spacing:16, padding:"8px 16px"
      };
      const DEFAULT_FOOTER = {
        area:"footer",
        footer_text:"© 合同会社WaJu", footer_alignment:"center", footer_fixed:false,
        bg_color:"#111827", bg_gradient:"", text_color:"#ffffff",
        font_family:"Noto Sans JP", font_size:14, font_weight:"normal",
        link_spacing:12, padding:"8px 16px"
      };
      const pick = (v,f)=> (v===undefined||v===null||v==="") ? f : v;

      // ----- HF Settings
      async function loadArea(area){
        let { data, error } = await db.from("hf_settings").select("*").eq("area", area).limit(1).maybeSingle();
        if (error) console.warn("select hf_settings error:", error);
        if (!data) {
          const seed = area==="header"? DEFAULT_HEADER: DEFAULT_FOOTER;
          const { data:ins, error:insErr } = await db.from("hf_settings").insert(seed).select().single();
          if (insErr) { console.error("insert seed error:", insErr); return seed; }
          return ins;
        }
        return data;
      }
      async function saveArea(area, values){
        const row = (area==="header") ? headerRow : footerRow;
        if (row && row.id){
          const { error } = await db.from("hf_settings").update(values).eq("id", row.id);
          if (error) { console.error(error); toast("保存に失敗しました", "err"); return; }
          toast("保存しました", "ok");
        } else {
          const payload = { ...values, area };
          const { data, error } = await db.from("hf_settings").insert(payload).select().single();
          if (error) { console.error(error); toast("保存に失敗しました", "err"); return; }
          if (area==="header") headerRow=data; else footerRow=data;
          toast("作成しました", "ok");
        }
      }
      function renderHeader(d){
        const html = `
        <div class="hf-header" style="
          background:${d.bg_gradient || d.bg_color}; color:${d.text_color};
          font-family:${d.font_family}; font-size:${pick(d.font_size,16)}px; font-weight:${d.font_weight};
          padding:${d.padding}; display:flex; align-items:center; gap:${pick(d.link_spacing,16)}px; justify-content:space-between;">
          <div style="flex:1; text-align:${d.logo_alignment};">
            ${d.logo_url ? `<img src="${d.logo_url}" style="height:${pick(d.logo_height,48)}px; object-fit:contain;">` : ""}
          </div>
          <div style="flex:1; text-align:${d.company_alignment}; white-space:nowrap;">${d.company_name || ""}</div>
          <div style="flex:1; display:flex; justify-content:${d.nav_alignment}; gap:${pick(d.link_spacing,16)}px;">
            <span>Link</span><span>Link</span><span>Link</span>
          </div>
        </div>`;
        document.getElementById("headerPreview").innerHTML = html;
      }
      function renderFooter(d){
        const html = `
        <div class="hf-footer" style="
          background:${d.bg_gradient || d.bg_color}; color:${d.text_color};
          font-family:${d.font_family}; font-size:${pick(d.font_size,14)}px; font-weight:${d.font_weight};
          padding:${d.padding}; text-align:${d.footer_alignment}; ${d.footer_fixed?'position:sticky;bottom:0;':''}">
          ${d.footer_text || ""}
        </div>`;
        document.getElementById("footerPreview").innerHTML = html;
      }
      function fillHeaderForm(d){
        h_company_name.value = d.company_name ?? "";
        h_logo_url.value = d.logo_url ?? "";
        h_logo_height.value = d.logo_height ?? 48;
        h_logo_alignment.value = d.logo_alignment ?? "left";
        h_company_alignment.value = d.company_alignment ?? "left";
        h_nav_alignment.value = d.nav_alignment ?? "right";
        h_bg_color.value = d.bg_color ?? "#111827";
        h_bg_gradient.value = d.bg_gradient ?? "";
        h_text_color.value = d.text_color ?? "#ffffff";
        h_font_family.value = d.font_family ?? "Noto Sans JP";
        h_font_size.value = d.font_size ?? 16;
        h_font_weight.value = d.font_weight ?? "normal";
        h_link_spacing.value = d.link_spacing ?? 16;
        h_padding.value = d.padding ?? "8px 16px";
      }
      function getHeaderValues(){
        return {
          company_name:h_company_name.value.trim(),
          logo_url:h_logo_url.value.trim(),
          logo_height:+h_logo_height.value||48,
          logo_alignment:h_logo_alignment.value,
          company_alignment:h_company_alignment.value,
          nav_alignment:h_nav_alignment.value,
          bg_color:h_bg_color.value||"#111827",
          bg_gradient:h_bg_gradient.value.trim(),
          text_color:h_text_color.value||"#ffffff",
          font_family:h_font_family.value.trim()||"Noto Sans JP",
          font_size:+h_font_size.value||16,
          font_weight:h_font_weight.value||"normal",
          link_spacing:+h_link_spacing.value||16,
          padding:h_padding.value.trim()||"8px 16px"
        };
      }
      function fillFooterForm(d){
        f_footer_text.value = d.footer_text ?? "";
        f_footer_alignment.value = d.footer_alignment ?? "center";
        f_bg_color.value = d.bg_color ?? "#111827";
        f_bg_gradient.value = d.bg_gradient ?? "";
        f_text_color.value = d.text_color ?? "#ffffff";
        f_font_family.value = d.font_family ?? "Noto Sans JP";
        f_font_size.value = d.font_size ?? 14;
        f_font_weight.value = d.font_weight ?? "normal";
        f_link_spacing.value = d.link_spacing ?? 12;
        f_footer_fixed.checked = !!d.footer_fixed;
        f_padding.value = d.padding ?? "8px 16px";
      }
      function getFooterValues(){
        return {
          footer_text:f_footer_text.value.trim(),
          footer_alignment:f_footer_alignment.value,
          bg_color:f_bg_color.value||"#111827",
          bg_gradient:f_bg_gradient.value.trim(),
          text_color:f_text_color.value||"#ffffff",
          font_family:f_font_family.value.trim()||"Noto Sans JP",
          font_size:+f_font_size.value||14,
          font_weight:f_font_weight.value||"normal",
          link_spacing:+f_link_spacing.value||12,
          footer_fixed:!!f_footer_fixed.checked,
          padding:f_padding.value.trim()||"8px 16px"
        };
      }

      // ----- メニュー
      async function fetchMenus(){
        const { data, error } = await db.from("public_menus").select("*").order("sort_order");
        if (error){ console.error(error); toast("メニュー読込に失敗", "err"); return []; }
        return data||[];
      }
      function renderMenusTable(rows){
        const tbody = document.querySelector("#menuTable tbody");
        tbody.innerHTML = rows.map(m => `
          <tr data-id="${m.id}">
            <td>${m.id}</td>
            <td><input class="m_title" value="${m.title??""}"></td>
            <td><input class="m_url" value="${m.url??""}"></td>
            <td><input class="m_sort" type="number" value="${m.sort_order??0}" style="width:80px"></td>
            <td><input class="m_sh" type="checkbox" ${m.show_header?"checked":""}></td>
            <td><input class="m_sf" type="checkbox" ${m.show_footer?"checked":""}></td>
            <td><input class="m_active" type="checkbox" ${m.is_active?"checked":""}></td>
            <td class="row-actions">
              <button class="btn m_save">保存</button>
              <button class="btn m_del">削除</button>
            </td>
          </tr>
        `).join("");
        // handlers
        tbody.querySelectorAll(".m_save").forEach(btn=>btn.addEventListener("click", async (e)=>{
          const tr = e.target.closest("tr");
          const id = tr.getAttribute("data-id");
          const payload = {
            title: tr.querySelector(".m_title").value.trim(),
            url: tr.querySelector(".m_url").value.trim(),
            sort_order: +tr.querySelector(".m_sort").value || 0,
            show_header: tr.querySelector(".m_sh").checked,
            show_footer: tr.querySelector(".m_sf").checked,
            is_active: tr.querySelector(".m_active").checked,
          };
          const { error } = await db.from("public_menus").update(payload).eq("id", id);
          if (error){ console.error(error); toast("メニュー保存に失敗", "err"); }
          else { toast("メニューを保存しました", "ok"); }
        }));
        tbody.querySelectorAll(".m_del").forEach(btn=>btn.addEventListener("click", async (e)=>{
          const tr = e.target.closest("tr");
          const id = tr.getAttribute("data-id");
          if (!confirm("削除しますか？")) return;
          const { error } = await db.from("public_menus").delete().eq("id", id);
          if (error){ console.error(error); toast("削除に失敗", "err"); }
          else { tr.remove(); toast("削除しました", "ok"); }
        }));
      }
      async function addMenuRow(){
        const { data, error } = await db.from("public_menus").insert({
          title:"新規メニュー", url:"#", sort_order:999, is_active:true, show_header:true, show_footer:false
        }).select().single();
        if (error){ console.error(error); toast("追加に失敗", "err"); return; }
        const rows = await fetchMenus();
        renderMenusTable(rows);
        toast("メニューを追加しました", "ok");
      }

      // ----- 初期化
      async function init(){
        // HF settings
        headerRow = await loadArea("header");
        footerRow = await loadArea("footer");
        fillHeaderForm(headerRow); renderHeader(headerRow);
        fillFooterForm(footerRow); renderFooter(footerRow);

        // live preview
        ["h_company_name","h_logo_url","h_logo_height","h_logo_alignment","h_company_alignment","h_nav_alignment","h_bg_color","h_bg_gradient","h_text_color","h_font_family","h_font_size","h_font_weight","h_link_spacing","h_padding"]
          .forEach(id => document.getElementById(id).addEventListener("input", ()=>renderHeader(getHeaderValues())));
        ["f_footer_text","f_footer_alignment","f_bg_color","f_bg_gradient","f_text_color","f_font_family","f_font_size","f_font_weight","f_link_spacing","f_footer_fixed","f_padding"]
          .forEach(id => document.getElementById(id).addEventListener(
            id==="f_footer_fixed" ? "change":"input", ()=>renderFooter(getFooterValues())
          ));

        // save buttons
        document.getElementById("saveHeaderBtn").onclick = async ()=>{ await saveArea("header", getHeaderValues()); };
        document.getElementById("saveFooterBtn").onclick = async ()=>{ await saveArea("footer", getFooterValues()); };

        // menus
        document.getElementById("addMenuBtn").onclick = addMenuRow;
        renderMenusTable(await fetchMenus());
      }
      init();
    }catch(e){
      console.error(e);
      toast("初期化に失敗しました", "err");
    }
  })();
})();
</script>
