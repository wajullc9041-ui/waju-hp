<!-- HF管理フラグメント (hf_settings対応版, 完全版) -->

<div id="hf-admin-root">
  <h2>ヘッダー & フッター 管理</h2>

  <!-- ヘッダー設定 -->
  <section class="panel">
    <div class="panel-head">
      <h3>ヘッダー設定</h3>
      <button id="saveHeaderBtn" class="btn primary">保存</button>
    </div>
    <div id="headerPreview" class="preview-surface"></div>
    <div class="edit-grid" id="headerForm"></div>
  </section>

  <!-- フッター設定 -->
  <section class="panel">
    <div class="panel-head">
      <h3>フッター設定</h3>
      <button id="saveFooterBtn" class="btn primary">保存</button>
    </div>
    <div id="footerPreview" class="preview-surface"></div>
    <div class="edit-grid" id="footerForm"></div>
  </section>

  <!-- メニュー管理 -->
  <section class="panel">
    <div class="panel-head">
      <h3>メニュー管理</h3>
      <button id="addMenuBtn" class="btn">新規追加</button>
    </div>
    <table id="menuTable">
      <thead><tr><th>ID</th><th>タイトル</th><th>URL</th><th>順序</th><th>Header</th><th>Footer</th><th>公開</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<div id="toast-container"></div>

<style>
  .panel { background:#fff; margin:20px 0; padding:24px; border-radius:14px; box-shadow:0 6px 16px rgba(0,0,0,.08); }
  .panel-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
  .panel-head h3 { font-size:18px; font-weight:600; }
  .btn { padding:8px 14px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
  .btn.primary { background:#2563eb; color:#fff; }
  .preview-surface { border:2px dashed #cbd5e1; padding:20px; min-height:70px; border-radius:12px; background:#f8fafc; margin-bottom:16px; }
  .edit-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:18px; }
  .field { display:flex; flex-direction:column; }
  .field label { font-size:13px; margin-bottom:6px; font-weight:500; }
  input,select { padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; font-size:14px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th,td { border-bottom:1px solid #e5e7eb; padding:8px; font-size:14px; }
  th { background:#f1f5f9; text-align:left; font-weight:600; }
  .row-actions { display:flex; gap:6px; }
  #toast-container { position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:9999; }
  .toast { background:#111827; color:#fff; padding:10px 14px; border-radius:8px; font-size:14px; opacity:.95; }
  .toast.ok { background:#065f46; }
  .toast.err { background:#7f1d1d; }
</style>

<script>
(async function(){
  const SUPABASE_URL="https://htnmjsqgoapvuanrsuma.supabase.co";
  const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0bm1qc3Fnb2FwdnVhbnJzdW1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzI3MDEsImV4cCI6MjA3MDkwODcwMX0.1AACTWZmChfmIIfBad0sf-hLV2bnaUt7bVURXnd0uKA";
  if(!window.supabase){await new Promise(res=>{const s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";s.onload=res;document.head.appendChild(s);});}
  const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON);
  function toast(msg,type="ok"){const w=document.getElementById("toast-container");const e=document.createElement("div");e.className="toast "+type;e.textContent=msg;w.appendChild(e);setTimeout(()=>{e.style.opacity="0";setTimeout(()=>e.remove(),300)},2000);}

  const headerFields=[
    {id:"company_name",label:"会社名",type:"text"},
    {id:"logo_url",label:"ロゴURL",type:"text"},
    {id:"logo_height",label:"ロゴ高さ(px)",type:"number"},
    {id:"logo_alignment",label:"ロゴ位置",type:"select",options:["left","center","right"]},
    {id:"company_alignment",label:"会社名位置",type:"select",options:["left","center","right"]},
    {id:"nav_alignment",label:"ナビ位置",type:"select",options:["left","center","right"]},
    {id:"bg_color",label:"背景色",type:"color"},
    {id:"bg_gradient",label:"背景グラデーション",type:"text"},
    {id:"text_color",label:"文字色",type:"color"},
    {id:"font_family",label:"フォント",type:"text"},
    {id:"font_size",label:"文字サイズ(px)",type:"number"},
    {id:"font_weight",label:"文字太さ",type:"select",options:["normal","bold"]},
    {id:"link_spacing",label:"リンク間隔(px)",type:"number"},
    {id:"padding",label:"パディング",type:"text"}
  ];
  const footerFields=[
    {id:"footer_text",label:"コピーライト",type:"text"},
    {id:"footer_alignment",label:"配置",type:"select",options:["left","center","right"]},
    {id:"bg_color",label:"背景色",type:"color"},
    {id:"bg_gradient",label:"背景グラデーション",type:"text"},
    {id:"text_color",label:"文字色",type:"color"},
    {id:"font_family",label:"フォント",type:"text"},
    {id:"font_size",label:"文字サイズ(px)",type:"number"},
    {id:"font_weight",label:"文字太さ",type:"select",options:["normal","bold"]},
    {id:"link_spacing",label:"リンク間隔(px)",type:"number"},
    {id:"footer_fixed",label:"固定表示",type:"checkbox"},
    {id:"padding",label:"パディング",type:"text"}
  ];

  function buildForm(container,fields,prefix){
    container.innerHTML=fields.map(f=>{
      if(f.type==="select"){
        return `<div class="field"><label>${f.label}</label><select id="${prefix}_${f.id}">${f.options.map(o=>`<option>${o}</option>`).join("")}</select></div>`;
      }else if(f.type==="checkbox"){
        return `<div class="field"><label>${f.label}</label><input type="checkbox" id="${prefix}_${f.id}"></div>`;
      }else{
        return `<div class="field"><label>${f.label}</label><input type="${f.type}" id="${prefix}_${f.id}"></div>`;
      }
    }).join("");
  }
  buildForm(document.getElementById("headerForm"),headerFields,"h");
  buildForm(document.getElementById("footerForm"),footerFields,"f");

  async function loadArea(area){let {data}=await db.from("hf_settings").select("*").eq("area",area).maybeSingle();if(!data){const {data:ins}=await db.from("hf_settings").insert({area}).select().single();return ins;}return data;}
  async function saveArea(area,values){let {data}=await db.from("hf_settings").select("*").eq("area",area).maybeSingle();if(data){await db.from("hf_settings").update(values).eq("id",data.id);}else{await db.from("hf_settings").insert({...values,area});}toast("保存しました");}

  function renderHeader(d,menus){const nav=menus.filter(m=>m.show_header&&m.is_active).sort((a,b)=>a.sort_order-b.sort_order).map(m=>`<a href="${m.url}">${m.title}</a>`).join("");document.getElementById("headerPreview").innerHTML=`<div style="background:${d.bg_gradient||d.bg_color};color:${d.text_color};font-family:${d.font_family};font-size:${d.font_size}px;font-weight:${d.font_weight};padding:${d.padding};display:flex;justify-content:space-between;align-items:center;"><div>${d.company_name||""}</div><nav...
  function renderFooter(d,menus){const nav=menus.filter(m=>m.show_footer&&m.is_active).sort((a,b)=>a.sort_order-b.sort_order).map(m=>`<a href="${m.url}">${m.title}</a>`).join("");document.getElementById("footerPreview").innerHTML=`<div style="background:${d.bg_gradient||d.bg_color};color:${d.text_color};font-family:${d.font_family};font-size:${d.font_size}px;font-weight:${d.font_weight};padding:${d.padding};text-align:${d.footer_alignment};${d.footer_fixed?"position:sticky;bottom:0;":""}">${d.footer_text...

  function fillForm(fields,prefix,data){fields.forEach(f=>{const el=document.getElementById(prefix+"_"+f.id);if(!el)return;if(f.type==="checkbox"){el.checked=!!data[f.id];}else{el.value=data[f.id]??"";}});}
  function getValues(fields,prefix){const v={};fields.forEach(f=>{const el=document.getElementById(prefix+"_"+f.id);if(!el)return;v[f.id]=(f.type==="checkbox"?el.checked:el.value);});return v;}

  const menus=(await db.from("public_menus").select("*")).data||[];
  const headerRow=await loadArea("header"); fillForm(headerFields,"h",headerRow); renderHeader(headerRow,menus);
  const footerRow=await loadArea("footer"); fillForm(footerFields,"f",footerRow); renderFooter(footerRow,menus);

  document.querySelectorAll("#headerForm input,#headerForm select").forEach(el=>el.addEventListener("input",()=>renderHeader(getValues(headerFields,"h"),menus)));
  document.querySelectorAll("#footerForm input,#footerForm select").forEach(el=>el.addEventListener("input",()=>renderFooter(getValues(footerFields,"f"),menus)));

  document.getElementById("saveHeaderBtn").onclick=()=>saveArea("header",getValues(headerFields,"h"));
  document.getElementById("saveFooterBtn").onclick=()=>saveArea("footer",getValues(footerFields,"f"));

  async function fetchMenus(){let {data}=await db.from("public_menus").select("*").order("sort_order");return data||[];}
  function renderMenusTable(rows){const tb=document.querySelector("#menuTable tbody");tb.innerHTML=rows.map(m=>`<tr data-id="${m.id}"><td>${m.id}</td><td><input class="m_title" value="${m.title||""}"></td><td><input class="m_url" value="${m.url||""}"></td><td><input class="m_sort" type="number" value="${m.sort_order||0}"></td><td><input class="m_sh" type="checkbox" ${m.show_header?"checked":""}></td><td><input class="m_sf" type="checkbox" ${m.show_footer?"checked":""}></td><td><input class="m_act" type="ch...
  renderMenusTable(await fetchMenus());
  document.getElementById("addMenuBtn").onclick=async()=>{await db.from("public_menus").insert({title:"新規メニュー",url:"#",sort_order:999,is_active:true,show_header:true,show_footer:false});renderMenusTable(await fetchMenus());};
})();</script>
