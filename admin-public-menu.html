<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>公開メニュー管理</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f5f5f5; }
    .toast { padding: 10px; margin-top: 10px; border-radius: 5px; }
    .toast.success { background: #d4edda; color: #155724; }
    .toast.error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>公開メニュー管理</h1>

  <form id="menuForm">
    <label>表示名: <input type="text" id="title"></label>
    <label>URL: <input type="text" id="url" placeholder="/about.html"></label>
    <label>ヘッダー表示: <input type="checkbox" id="show_in_header" checked></label>
    <label>フッター表示: <input type="checkbox" id="show_in_footer"></label>
    <button type="button" onclick="addMenu()">追加</button>
  </form>

  <div id="toast"></div>

  <table id="menuTable">
    <thead>
      <tr>
        <th>ID</th><th>表示名</th><th>URL</th><th>ヘッダー</th><th>フッター</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const supabaseUrl = "https://htnmjsqgoapvuanrsuma.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0bm1qc3Fnb2FwdnVhbnJzdW1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzI3MDEsImV4cCI6MjA3MDkwODcwMX0.1AACTWZmChfmIIfBad0sf-hLV2bnaUt7bVURXnd0uKA";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

function toast(msg, type="success") {
  const el = document.getElementById("toast");
  el.innerHTML = `<div class="toast ${type}">${msg}</div>`;
  setTimeout(()=>{ el.innerHTML=""; }, 3000);
}

function readMenuForm(){
  return {
    title: document.getElementById("title").value.trim(),
    url: document.getElementById("url").value.trim(),
    show_in_header: document.getElementById("show_in_header").checked,
    show_in_footer: document.getElementById("show_in_footer").checked
  };
}

function resetMenuForm(){
  document.getElementById("title").value = "";
  document.getElementById("url").value = "";
  document.getElementById("show_in_header").checked = true;
  document.getElementById("show_in_footer").checked = false;
}

async function fetchMenus(){
  const { data, error } = await supabase.from("public_menus").select("*").order("id");
  if(error){
    console.error(error);
    toast("読み込み失敗","error");
    return;
  }
  const tbody = document.querySelector("#menuTable tbody");
  tbody.innerHTML = "";
  data.forEach(row=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.id}</td>
      <td>${row.title}</td>
      <td>${row.url}</td>
      <td>${row.show_in_header ? "✔" : ""}</td>
      <td>${row.show_in_footer ? "✔" : ""}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function addMenu(){
  const rec = readMenuForm();
  if(!rec.title || !rec.url){
    toast("表示名とURLは必須です","error");
    return;
  }

  // public_menus に追加
  const { data, error } = await supabase.from("public_menus").insert([rec]).select().single();
  if(error){
    console.error(error);
    toast("追加失敗","error");
    return;
  }

  // URLから slug を生成（例: "/about.html" → "about"）
  let slug = rec.url.replace(/^\//,"").replace(/\.html$/,"");
  if(!slug) slug = "page-" + data.id; // 念のためfallback

  // pages にも初期レコードを追加
  const { error: pageErr } = await supabase.from("pages").insert([{
    slug: slug,
    title: rec.title,
    content: `<h1>${rec.title}</h1><p>ここに本文を入力してください。</p>`,
    updated_at: new Date().toISOString()
  }]);

  if(pageErr){
    console.error(pageErr);
    toast("ページ作成に失敗","error");
  }

  resetMenuForm();
  await fetchMenus();
  toast("追加しました");
}

fetchMenus();
</script>
</body>
</html>
