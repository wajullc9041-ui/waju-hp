<!-- 管理: ヘッダー＆フッター設定（完全修正版：プレビュー維持＋HTMLも保存） -->
<!-- 既存のCSS/HTML構造はそのまま -->

<!-- 中略: CSSとHTML部分は元のコードをそのまま利用 -->

<script type="module">
  let supabase;
  if (!window.__supabase) {
    const { createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm");
    window.__supabase = createClient(
      "https://htnmjsqgoapvuanrsuma.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0bm1qc3Fnb2FwdnVhbnJzdW1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzI3MDEsImV4cCI6MjA3MDkwODcwMX0.1AACTWZmChfmIIfBad0sf-hLV2bnaUt7bVURXnd0uKA"
    );
  }
  supabase = window.__supabase;

  const $ = (q, r=document)=> r.querySelector(q);
  const $$ = (q, r=document)=> Array.from(r.querySelectorAll(q));
  const toast = (m, ok=true)=>{const n=document.createElement('div');n.className='toast '+(ok?'':'err');n.textContent=m;(document.querySelector('#toast')||document.body).appendChild(n);setTimeout(()=>n.remove(),2200);};

  // ====== ここまで既存の buildHeaderDOM / buildFooterDOM / getHeader / getFooter / setHeader / setFooter など全て残す ======
  // （省略はしているが、元の admin-hf-setting.txt の関数群は全て残してください）

  async function saveRow(area, payload){
    const { error } = await supabase.from('hf_settings').update({ data: payload }).eq('area', area);
    if (error){ console.error(error); toast('保存失敗', false); return; }
    toast('保存しました', true);
  }

  let menus = [];
  (async function init(){
    const m = await supabase.from('public_menus').select('*').order('sort_order', {ascending:true});
    menus = m.data || [];

    const h = await supabase.from('hf_settings').select('*').eq('area','header').single();
    const f = await supabase.from('hf_settings').select('*').eq('area','footer').single();
    setHeader((h.data && h.data.data) || {});
    setFooter((f.data && f.data.data) || {});
    renderHeaderPreview(getHeader(), menus);
    renderFooterPreview(getFooter(), menus);

    // 入力変更イベントは従来通り

    // 保存処理（修正版）
    $("#saveHeader").addEventListener("click", async function(){
      const d = getHeader();
      renderHeaderPreview(d, menus);              // プレビュー維持
      const dom = buildHeaderDOM(d, menus);
      d.headerHtml = dom.outerHTML;               // HTML文字列も保存
      await saveRow("header", d);
    });

    $("#saveFooter").addEventListener("click", async function(){
      const d = getFooter();
      renderFooterPreview(d, menus);              // プレビュー維持
      const dom = buildFooterDOM(d, menus);
      d.footerHtml = dom.outerHTML;               // HTML文字列も保存
      await saveRow("footer", d);
    });
  })();
</script>
