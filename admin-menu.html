<div class="container">
  <h2>管理メニュー管理</h2>
  <div class="form-group">
    <label for="menu_title">表示名：</label>
    <input type="text" id="menu_title" />
  </div>
  <div class="form-group">
    <label for="menu_filename">リンク先HTML：</label>
    <input type="text" id="menu_filename" />
  </div>
  <div class="form-group">
    <label for="menu_order">順番（数字）：</label>
    <input type="number" id="menu_order" />
  </div>
  <div class="form-group">
    <label><input type="checkbox" id="menu_active" /> 公開状態</label>
  </div>
  <button id="addBtn">追加</button>
  <button id="updateBtn" style="display:none;">更新</button>
  <button id="cancelBtn" style="display:none;">キャンセル</button>

  <table id="menuTable">
    <thead>
      <tr>
        <th style="width:60px;">ID</th>
        <th>表示名</th>
        <th>HTML</th>
        <th style="width:80px;">順番</th>
        <th style="width:80px;">公開</th>
        <th style="width:140px;">操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="toast-container"></div>

<style>
  .container {
    padding: 20px;
    font-family: "Segoe UI", sans-serif;
    background: #f3f4f6;
    border-radius: 0.5rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  h2 { margin-bottom: 1rem; color: #1f2937; }
  .form-group { margin-bottom: 10px; }
  input[type=text], input[type=number] {
    padding: 6px; width: 100%;
    border: 1px solid #ccc; border-radius: 4px;
  }
  button {
    margin-right: 5px; padding: 6px 12px;
    border: none; border-radius: 4px; cursor: pointer;
  }
  #addBtn { background-color: #2563eb; color: white; }
  #updateBtn { background-color: #10b981; color: white; }
  #cancelBtn { background-color: #6b7280; color: white; }
  .deleteBtn { background-color: #ef4444; color: white; }
  .editBtn { background-color: #3b82f6; color: white; margin-right: 4px; }
  table {
    margin-top: 20px; border-collapse: collapse;
    width: 100%; background: #fff;
    border-radius: 0.5rem; overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  th, td {
    border: 1px solid #e5e7eb; padding: 8px; text-align: center;
  }
  th { background-color: #f9fafb; }
  tr:hover { background-color: #f3f4f6; }
  tbody tr { cursor: move; }
  #toast-container {
    position: fixed; top: 1rem; right: 1rem; z-index: 9999;
  }
  .toast {
    margin-bottom: 10px; padding: 10px 16px;
    border-radius: 4px; color: white; font-weight: 500;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    animation: fadeInOut 3s forwards;
  }
  .toast.success { background-color: #10b981; }
  .toast.error { background-color: #ef4444; }
  @keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(-10px); }
    10% { opacity: 1; transform: translateY(0); }
    90% { opacity: 1; }
    100% { opacity: 0; transform: translateY(-10px); }
  }
</style>

<script>
  var sb = window.supabase;
  if (!sb) {
    alert("Supabaseが初期化されていません。トップページを再読込してください。");
  }

  let editingId = null;

  function showToast(message, type="success") {
    const toast = document.createElement("div");
    toast.className = "toast " + type;
    toast.textContent = message;
    document.getElementById("toast-container").appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  async function fetchMenus() {
    const { data, error } = await sb
      .from('admin_menus')
      .select('*')
      .order('sort_order', { ascending: true });
    if (error) { console.error(error); showToast("読み込みに失敗しました","error"); return; }

    const tbody = document.querySelector("#menuTable tbody");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.draggable = true;
      tr.dataset.id = String(row.id);
      tr.innerHTML = `
        <td>${row.id}</td>
        <td>${row.title}</td>
        <td>${row.filename}</td>
        <td>${row.sort_order}</td>
        <td>${row.is_active ? "✓" : ""}</td>
        <td>
          <button class="editBtn" data-id="${row.id}">編集</button>
          <button class="deleteBtn" data-id="${row.id}">削除</button>
        </td>`;
      tbody.appendChild(tr);
    });

    document.querySelectorAll(".editBtn").forEach(btn => {
      btn.addEventListener("click", () => startEdit(Number(btn.dataset.id)));
    });
    document.querySelectorAll(".deleteBtn").forEach(btn => {
      btn.addEventListener("click", () => deleteMenu(Number(btn.dataset.id)));
    });

    enableDragAndDrop();
  }

  async function addMenu() {
    const title = document.getElementById("menu_title").value.trim();
    const filename = document.getElementById("menu_filename").value.trim();
    const order = parseInt(document.getElementById("menu_order").value.trim(), 10);
    const active = document.getElementById("menu_active").checked;
    if (!title || !filename || isNaN(order)) {
      showToast("必須項目を入力してください","error");
      return;
    }
    const { error } = await sb.from("admin_menus").insert([
      { title, filename, sort_order: order, is_active: active }
    ]);
    if (error) { console.error(error); showToast("追加に失敗しました","error"); return; }
    resetForm(); fetchMenus(); showToast("追加しました","success");
  }

  function startEdit(id) {
    editingId = id;
    document.getElementById("addBtn").style.display = "none";
    document.getElementById("updateBtn").style.display = "inline-block";
    document.getElementById("cancelBtn").style.display = "inline-block";
    fillForm(id);
  }

  async function fillForm(id) {
    const { data, error } = await sb.from("admin_menus").select("*").eq("id", id).single();
    if (error) { console.error(error); showToast("読込に失敗しました","error"); return; }
    if (data) {
      document.getElementById("menu_title").value = data.title;
      document.getElementById("menu_filename").value = data.filename;
      document.getElementById("menu_order").value = data.sort_order;
      document.getElementById("menu_active").checked = data.is_active;
    }
  }

  async function updateMenu() {
    if (editingId == null) return;
    const title = document.getElementById("menu_title").value.trim();
    const filename = document.getElementById("menu_filename").value.trim();
    const order = parseInt(document.getElementById("menu_order").value.trim(), 10);
    const active = document.getElementById("menu_active").checked;
    const { error } = await sb
      .from("admin_menus")
      .update({ title, filename, sort_order: order, is_active: active })
      .eq("id", Number(editingId));
    if (error) { console.error(error); showToast("更新に失敗しました","error"); return; }
    resetForm(); fetchMenus(); showToast("更新しました","success");
  }

  async function deleteMenu(id) {
    if (!confirm("削除してよろしいですか？")) return;
    const { error } = await sb.from("admin_menus").delete().eq("id", Number(id));
    if (error) { console.error(error); showToast("削除に失敗しました","error"); return; }
    fetchMenus(); showToast("削除しました","success");
  }

  function resetForm() {
    editingId = null;
    document.getElementById("menu_title").value = "";
    document.getElementById("menu_filename").value = "";
    document.getElementById("menu_order").value = "";
    document.getElementById("menu_active").checked = false;
    document.getElementById("addBtn").style.display = "inline-block";
    document.getElementById("updateBtn").style.display = "none";
    document.getElementById("cancelBtn").style.display = "none";
  }

  function enableDragAndDrop() {
    const tbody = document.querySelector("#menuTable tbody");
    let dragEl = null;

    tbody.querySelectorAll("tr").forEach(tr => {
      tr.addEventListener("dragstart", e => {
        dragEl = tr;
        e.dataTransfer.effectAllowed = "move";
      });
      tr.addEventListener("dragover", e => {
        e.preventDefault();
        const rect = tr.getBoundingClientRect();
        const offset = e.clientY - rect.top - rect.height / 2;
        if (offset > 0) {
          tr.style.borderBottom = "2px solid #3b82f6";
          tr.style.borderTop = "";
        } else {
          tr.style.borderTop = "2px solid #3b82f6";
          tr.style.borderBottom = "";
        }
      });
      tr.addEventListener("dragleave", () => {
        tr.style.borderTop = "";
        tr.style.borderBottom = "";
      });
      tr.addEventListener("drop", async e => {
        e.preventDefault();
        tr.style.borderTop = "";
        tr.style.borderBottom = "";
        if (dragEl && dragEl !== tr) {
          const afterHalf = e.clientY > tr.getBoundingClientRect().top + tr.offsetHeight/2;
          tbody.insertBefore(dragEl, afterHalf ? tr.nextSibling : tr);
          await saveNewOrder();
        }
        dragEl = null;
      });
    });
  }

  async function saveNewOrder() {
    const tbody = document.querySelector("#menuTable tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    let errors = [];
    for (let i=0; i<rows.length; i++) {
      const id = Number(rows[i].dataset.id);
      const newOrder = i + 1;
      const currentOrder = Number(rows[i].children[3].textContent);
      if (currentOrder === newOrder) continue;
      const { error } = await sb.from("admin_menus").update({ sort_order: newOrder }).eq("id", id);
      if (error) { console.error("sort update error:", {id, error}); errors.push(error); }
      else { rows[i].children[3].textContent = String(newOrder); }
    }
    if (errors.length) showToast("順番の保存でエラーが発生しました","error");
    else showToast("順番を更新しました","success");
    fetchMenus();
  }

  document.getElementById("addBtn").addEventListener("click", addMenu);
  document.getElementById("updateBtn").addEventListener("click", updateMenu);
  document.getElementById("cancelBtn").addEventListener("click", resetForm);

  fetchMenus();
</script>
