
<!-- 管理メニュー管理ページ本体 -->
<div class="content-container">
  <h2>管理メニュー管理</h2>
  <form id="menuForm">
    <div>
      <label>表示名：</label>
      <input type="text" id="title" required>
    </div>
    <div>
      <label>リンク先HTML：</label>
      <input type="text" id="filename" required>
    </div>
    <div>
      <label>順番（数字）：</label>
      <input type="number" id="sort_order" required>
    </div>
    <div>
      <label><input type="checkbox" id="is_active"> 公開状態</label>
    </div>
    <button type="submit">追加</button>
  </form>

  <table id="menuTable">
    <thead>
      <tr>
        <th>表示名</th>
        <th>HTML</th>
        <th>順番</th>
        <th>公開</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<style>
  .content-container {
    padding: 20px;
  }
  #menuForm div {
    margin-bottom: 10px;
  }
  #menuForm input[type="text"],
  #menuForm input[type="number"] {
    padding: 4px;
    width: 300px;
  }
  #menuForm button {
    padding: 6px 12px;
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 4px;
  }
  #menuForm button:hover {
    background-color: #0056b3;
  }
  #menuTable {
    margin-top: 20px;
    width: 100%;
    border-collapse: collapse;
  }
  #menuTable th, #menuTable td {
    padding: 8px 12px;
    border: 1px solid #ccc;
    text-align: left;
  }
  #menuTable th {
    background-color: #f4f4f4;
  }
</style>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const supabaseUrl = 'https://viihcgkjzzhkdiwdzdex.supabase.co'
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0bm1qc3Fnb2FwdnVhbnJzdW1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzI3MDEsImV4cCI6MjA3MDkwODcwMX0.1AACTWZmChfmIIfBad0sf-hLV2bnaUt7bVURXnd0uKA'
  const supabase = createClient(supabaseUrl, supabaseKey)

  // 認証セッションの復元
  const authSession = localStorage.getItem("sb-htnmjsqgoapvuansuma-auth-token")
  if (authSession) {
    const { access_token, refresh_token } = JSON.parse(authSession)
    if (access_token && refresh_token) {
      await supabase.auth.setSession({ access_token, refresh_token })
    }
  }

  const tableBody = document.querySelector('#menuTable tbody')
  const form = document.getElementById('menuForm')

  async function fetchMenus() {
    const { data, error } = await supabase
      .from('admin_menus')
      .select('*')
      .order('sort_order')

    if (error) {
      console.error('取得エラー:', error)
      return
    }

    tableBody.innerHTML = ''
    data.forEach(menu => {
      const row = document.createElement('tr')
      row.innerHTML = `
        <td>${menu.title}</td>
        <td>${menu.filename}</td>
        <td>${menu.sort_order}</td>
        <td>${menu.is_active ? '✔' : ''}</td>
      `
      tableBody.appendChild(row)
    })
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault()
    const title = document.getElementById('title').value
    const filename = document.getElementById('filename').value
    const sort_order = Number(document.getElementById('sort_order').value)
    const is_active = document.getElementById('is_active').checked

    const { error } = await supabase.from('admin_menus').insert([{ title, filename, sort_order, is_active }])
    if (error) {
      alert('追加失敗: ' + error.message)
    } else {
      form.reset()
      await fetchMenus()
    }
  })

  fetchMenus()
</script>
