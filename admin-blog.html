<div id="blog-admin">

  <h2>ブログ記事管理</h2>
  <form id="article-form">
    <label>タイトル
      <input type="text" id="title" required>
    </label>
    <label>Slug
      <input type="text" id="slug" required>
    </label>
    <label>カテゴリ
      <select id="category" required>
        <option value="">選択してください</option>
        <option>お知らせ</option>
        <option>プレスリリース</option>
        <option>イベント</option>
        <option>採用情報</option>
        <option>コラム</option>
        <option>制度・法改正</option>
        <option>サービス更新</option>
        <option>導入事例</option>
        <option>メディア掲載</option>
        <option>地域連携</option>
      </select>
    </label>
    <label>タグ（カンマ区切り）
      <input type="text" id="tags">
    </label>
    <label>説明
      <textarea id="description"></textarea>
    </label>
    <label>本文
      <textarea id="content"></textarea>
    </label>
    <label>サムネイルURL
      <input type="url" id="thumbnail_url">
    </label>
    <label>公開
      <input type="checkbox" id="published">
    </label>
    <button type="submit">保存</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>タイトル</th>
        <th>Slug</th>
        <th>カテゴリ</th>
        <th>タグ</th>
        <th>状態</th>
        <th>作成日</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="articles-list"></tbody>
  </table>

</div>

<script>
  async function loadArticles() {
    const { data, error } = await supabase
      .from("articles")
      .select("*")
      .order("created_at", { ascending: false });
    if (error) {
      console.error(error);
      return;
    }
    const list = document.getElementById("articles-list");
    list.innerHTML = "";
    data.forEach(a => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${a.title}</td>
        <td>${a.slug}</td>
        <td>${a.category || ""}</td>
        <td>${(a.tags || []).join(",")}</td>
        <td>${a.published ? "公開" : "下書き"}</td>
        <td>${new Date(a.created_at).toLocaleDateString()}</td>
        <td><button onclick='editArticle(${JSON.stringify(a)})'>編集</button></td>
      `;
      list.appendChild(tr);
    });
  }

  async function saveArticle(e) {
    e.preventDefault();
    const row = {
      title: document.getElementById("title").value,
      slug: document.getElementById("slug").value,
      category: document.getElementById("category").value,
      tags: document.getElementById("tags").value.split(",").map(s => s.trim()).filter(s => s),
      description: document.getElementById("description").value,
      content: document.getElementById("content").value,
      thumbnail_url: document.getElementById("thumbnail_url").value,
      published: document.getElementById("published").checked
    };
    let { error } = await supabase.from("articles").upsert(row, { onConflict: ["slug"] });
    if (error) {
      console.error(error);
    }
    await loadArticles();
    e.target.reset();
  }

  function editArticle(a) {
    document.getElementById("title").value = a.title || "";
    document.getElementById("slug").value = a.slug || "";
    document.getElementById("category").value = a.category || "";
    document.getElementById("tags").value = (a.tags || []).join(",");
    document.getElementById("description").value = a.description || "";
    document.getElementById("content").value = a.content || "";
    document.getElementById("thumbnail_url").value = a.thumbnail_url || "";
    document.getElementById("published").checked = a.published || false;
  }

  document.getElementById("article-form").addEventListener("submit", saveArticle);
  loadArticles();
</script>
