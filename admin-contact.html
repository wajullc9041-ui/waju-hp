<div id="admin-contact">
  <div class="filter-bar">
    <input type="text" id="search" placeholder="検索..." />
    <select id="statusFilter">
      <option value="">すべてのステータス</option>
      <option value="未読">未読</option>
      <option value="対応中">対応中</option>
      <option value="対応済">対応済</option>
    </select>
    <select id="categoryFilter">
      <option value="">すべての種別</option>
      <option value="サービス導入相談">サービス導入相談</option>
      <option value="業務提携・連携・協業">業務提携・連携・協業</option>
      <option value="取材・メディア">取材・メディア</option>
      <option value="その他">その他</option>
    </select>
    <label>
      <input type="checkbox" id="importantFilter" />
      重要のみ
    </label>
  </div>

  <div id="messageList" class="card"></div>

  <div class="pagination">
    <button id="prevPage">前へ</button>
    <span id="pageInfo"></span>
    <button id="nextPage">次へ</button>
  </div>
</div>

<style>
#admin-contact {
  font-family: 'Segoe UI', sans-serif;
  color: #333;
}

#admin-contact .filter-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 1rem;
  align-items: center;
}

#admin-contact .filter-bar input,
#admin-contact .filter-bar select {
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

#admin-contact .card {
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  width: 90%;
  max-width: 1000px; /* メイン部分に収める */
  margin: 0 auto;
}

#admin-contact details {
  border-bottom: 1px solid #e5e7eb;
  padding: 10px;
}

#admin-contact summary {
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
}

#admin-contact .detail-content {
  margin-top: 10px;
  font-size: 14px;
  line-height: 1.5;
}

#admin-contact .detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 16px;
}

#admin-contact .detail-grid div {
  display: flex;
  flex-direction: column;
}

#admin-contact .actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 10px;
}

#admin-contact .pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  margin-top: 15px;
}

#admin-contact .pagination button {
  padding: 6px 12px;
  border: none;
  background: #2563eb;
  color: white;
  border-radius: 6px;
  cursor: pointer;
}
</style>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = "【ここにプロジェクトURL】";
const supabaseKey = "【ここにanonキー】";
const supabase = createClient(supabaseUrl, supabaseKey);

const listEl = document.getElementById("messageList");
const searchEl = document.getElementById("search");
const statusFilter = document.getElementById("statusFilter");
const categoryFilter = document.getElementById("categoryFilter");
const importantFilter = document.getElementById("importantFilter");
const prevPage = document.getElementById("prevPage");
const nextPage = document.getElementById("nextPage");
const pageInfo = document.getElementById("pageInfo");

let currentPage = 1;
const pageSize = 5;
let totalPages = 1;

async function fetchMessages() {
  let query = supabase.from("contact_messages").select("*", { count: "exact" });

  if (searchEl.value) {
    query = query.ilike("name", `%${searchEl.value}%`);
  }
  if (statusFilter.value) {
    query = query.eq("status", statusFilter.value);
  }
  if (categoryFilter.value) {
    query = query.eq("category", categoryFilter.value);
  }
  if (importantFilter.checked) {
    query = query.eq("is_important", true);
  }

  const { data, error, count } = await query
    .order("created_at", { ascending: false })
    .range((currentPage - 1) * pageSize, currentPage * pageSize - 1);

  if (error) {
    console.error(error);
    return;
  }

  totalPages = Math.ceil(count / pageSize);
  renderMessages(data);
}

function renderMessages(messages) {
  listEl.innerHTML = "";
  messages.forEach((msg) => {
    const details = document.createElement("details");
    const summary = document.createElement("summary");
    summary.innerHTML = `
      <span>${msg.name}（${msg.organization || "所属なし"}）</span>
      <span>${msg.subject} / ${msg.category}</span>
    `;

    const content = document.createElement("div");
    content.className = "detail-content";
    content.innerHTML = `
      <div class="detail-grid">
        <div><strong>氏名</strong><span>${msg.name}</span></div>
        <div><strong>会社・所属</strong><span>${msg.organization || ""}</span></div>
        <div><strong>メール</strong><span>${msg.email}</span></div>
        <div><strong>電話</strong><span>${msg.phone || ""}</span></div>
        <div><strong>ステータス</strong><span>${msg.status}</span></div>
        <div><strong>重要</strong><span>${msg.is_important ? "★" : "－"}</span></div>
        <div style="grid-column: 1 / -1;"><strong>本文</strong><p>${msg.message}</p></div>
      </div>
      <div class="actions">
        <button onclick="updateStatus('${msg.id}','未読')">未読</button>
        <button onclick="updateStatus('${msg.id}','対応中')">対応中</button>
        <button onclick="updateStatus('${msg.id}','対応済')">対応済</button>
        <button onclick="toggleImportant('${msg.id}', ${msg.is_important})">重要切替</button>
        <button onclick="deleteMessage('${msg.id}')">削除</button>
      </div>
    `;
    details.appendChild(summary);
    details.appendChild(content);
    listEl.appendChild(details);
  });

  pageInfo.textContent = `${currentPage} / ${totalPages} ページ`;
}

window.updateStatus = async (id, status) => {
  await supabase.from("contact_messages").update({ status }).eq("id", id);
  fetchMessages();
};

window.toggleImportant = async (id, current) => {
  await supabase.from("contact_messages").update({ is_important: !current }).eq("id", id);
  fetchMessages();
};

window.deleteMessage = async (id) => {
  if (confirm("削除してもよろしいですか？")) {
    await supabase.from("contact_messages").delete().eq("id", id);
    fetchMessages();
  }
};

searchEl.addEventListener("input", () => { currentPage = 1; fetchMessages(); });
statusFilter.addEventListener("change", () => { currentPage = 1; fetchMessages(); });
categoryFilter.addEventListener("change", () => { currentPage = 1; fetchMessages(); });
importantFilter.addEventListener("change", () => { currentPage = 1; fetchMessages(); });

prevPage.addEventListener("click", () => {
  if (currentPage > 1) {
    currentPage--;
    fetchMessages();
  }
});
nextPage.addEventListener("click", () => {
  if (currentPage < totalPages) {
    currentPage++;
    fetchMessages();
  }
});

fetchMessages();
</script>
